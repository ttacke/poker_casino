<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<script type="text/javascript" src="src/Casino/Besucher.js"></script>
		<script type="text/javascript" src="src/Casino/Spieler.js"></script>
		<script type="text/javascript" src="src/Casino/Croupier.js"></script>
		<script type="text/javascript">
			var CROUPIER_ID = window.location.search.substr(1, window.location.search.length);
			var GEHEIME_CROUPIER_ID = window.location.search.substr(1, window.location.search.length);
			var TISCH_ID = 'GrafZahl';
			var SPIELNAME = 'Zaehlen';
			var MIN_SPIELER = 2;
			var croupier = null;
			
			document.addEventListener("load", init, false);
			document.addEventListener("DOMContentLoaded", init, false);
			
			function init() {
				window.i = 0;
				window.sollAntwort = 0;
				window.aktuelleSpielerliste = [];
				window.aktuellerSpieler = -1;
				window.rundenzaehler = 0;
				window.anfragenZaehler = 0;
				window.anfragenStartZeit = new Date().getTime();
				document.getElementsByTagName('textarea')[0].value = '';
				
				croupier = new CasinoCroupier(CROUPIER_ID, GEHEIME_CROUPIER_ID);
				croupier.betrete("ws://localhost:8080/", function() {
					croupier.eroeffneTisch(TISCH_ID, SPIELNAME, function(daten) {
						if(daten.erfolg) {
							logge('Tisch "' + TISCH_ID + '" mit Spiel "' + SPIELNAME + '" er√∂ffnet: ' + daten.erfolg, true);
							warteAufSpieler();
						} else {
							logge("Tisch anlegen ist fehlgeschlagen", true);
							setTimeout('init()', 1000);
						}
					});
				});
			}
			// FLOAT
			function errechneGeschwindigkeit() {
				var zeitRaum = new Date().getTime() - window.anfragenStartZeit;
				var anfragenProSekunde = window.anfragenZaehler / (zeitRaum / 1000);
				window.anfragenZaehler = 0;
				window.anfragenStartZeit = new Date().getTime();
				return anfragenProSekunde;
			}
			function warteAufSpieler() {
				croupier.zeigeSpielerDesTisches(function(liste) {
					if(liste.length < MIN_SPIELER) {
						logge('warte auf min. ' + MIN_SPIELER + ' Spieler...', true);
						setTimeout('warteAufSpieler()', 1000);
						return;
					}
					spiele_runde(liste);
				});
			}
			function spiele_runde(liste) {
				window.rundenzaehler++;
				logge('Spielrunde#' + window.rundenzaehler);
				window.aktuellerSpieler = -1;
				window.aktuelleSpielerliste = liste;
				naechsterSpieler();
			}
			function naechsterSpieler() {
				window.aktuellerSpieler++;
				window.i++;
				var liste = window.aktuelleSpielerliste;
				if(window.aktuellerSpieler >= liste.length) {
					warteAufSpieler();
					return;
				}
				
				var aktuelleSpielerId = liste[window.aktuellerSpieler];
				croupier.frageDenSpieler(aktuelleSpielerId, window.sollAntwort, function(antwort) {
					window.sollAntwort++;
					window.anfragenZaehler++;
					if(antwort.status != 'OK' || antwort.antwort != window.sollAntwort) {
						logge(aktuelleSpielerId + ': FALSCH (IST:' + antwort.antwort + ', SOLL:' + window.sollAntwort + ', STATUS:' + antwort.status + ')', true);
					}
					naechsterSpieler();
				});
			}
			function logge(msg, zeigeDirekt) {
				if(window.i > 432 || zeigeDirekt) {
					document.getElementsByTagName('textarea')[0].value = msg + '(v = ' + errechneGeschwindigkeit() + ' PingPong/s)';
					window.i = 0;
				}
			}
		</script>
	</head>
	<body><textarea style="width: 100%;height: 270px;"></textarea></body>
</html>